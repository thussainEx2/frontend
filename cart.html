<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--favicon-->
	<link rel="icon" href="assets/images/favicon-32x32.webp" type="image/webp" />

  <!-- CSS files -->
  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <!-- Plugins -->
  <link rel="stylesheet" type="text/css" href="assets/plugins/slick/slick.css" />
  <link rel="stylesheet" type="text/css" href="assets/plugins/slick/slick-theme.css" />

  <link href="assets/css/style.css" rel="stylesheet">
  <link href="assets/css/dark-theme.css" rel="stylesheet">

  <title>Shopingo - eCommerce HTML Template</title>
</head>

<body>

  <!--page loader-->
  <div class="loader-wrapper">
   <div class="d-flex justify-content-center align-items-center position-absolute top-50 start-50 translate-middle">
     <div class="spinner-border text-dark" role="status">
       <span class="visually-hidden">Loading...</span>
     </div>
   </div>
 </div>
<!--end loader-->

  <!--start top header-->
  <div id="header-container">


  </div>
  <!--end top header-->


<!--start page content-->
<div class="page-content">


   <!--start breadcrumb-->
   <div class="py-4 border-bottom">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0"> 
          <li class="breadcrumb-item"><a href="javascript:;">Home</a></li>
          <li class="breadcrumb-item"><a href="javascript:;">Shop</a></li>
          <li class="breadcrumb-item active" aria-current="page">Cart</li>
        </ol>
      </nav>
    </div>
   </div>
   <!--end breadcrumb-->


   <!--start product details-->
   <section class="section-padding" id="cartItems">
    
  </section>
   <!--start product details-->


  
  
 </div>
  <!--end page content-->


  <!--start footer-->
  <section class="footer-section bg-section-2 section-padding">
    <div class="container">
       <div class="row row-cols-1 row-cols-lg-4 g-4">
        <div class="col">
          <div class="footer-widget-6">
            <img src="assets/images/logo.webp" class="logo-img mb-3" alt="">
            <h5 class="mb-3 fw-bold">About Us</h5>
             <p class="mb-2">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.</p>

             <a class="link-dark" href="javascript:;">Read More</a>
          </div>
        </div>
        <div class="col">
          <div class="footer-widget-7">
            <h5 class="mb-3 fw-bold">Explore</h5>
             <ul class="widget-link list-unstyled">
               <li><a href="javascript:;">Fashion</a></li>
               <li><a href="javascript:;">Women</a></li>
               <li><a href="javascript:;">Furniture</a></li>
               <li><a href="javascript:;">Shoes</a></li>
               <li><a href="javascript:;">Topwear</a></li>
               <li><a href="javascript:;">Brands</a></li>
               <li><a href="javascript:;">Kids</a></li>
             </ul>
          </div>
        </div>
        <div class="col">
          <div class="footer-widget-8">
            <h5 class="mb-3 fw-bold">Company</h5>
             <ul class="widget-link list-unstyled">
               <li><a href="javascript:;">About Us</a></li>
               <li><a href="javascript:;">Contact Us</a></li>
               <li><a href="javascript:;">FAQ</a></li>
               <li><a href="javascript:;">Privacy</a></li>
               <li><a href="javascript:;">Terms</a></li>
               <li><a href="javascript:;">Complaints</a></li>
             </ul>
          </div>
        </div>
        <div class="col">
          <div class="footer-widget-9">
            <h5 class="mb-3 fw-bold">Follow Us</h5>
             <div class="social-link d-flex align-items-center gap-2">
               <a href="javascript:;"><i class="bi bi-facebook"></i></a>
               <a href="javascript:;"><i class="bi bi-twitter"></i></a>
               <a href="javascript:;"><i class="bi bi-linkedin"></i></a>
               <a href="javascript:;"><i class="bi bi-youtube"></i></a>
               <a href="javascript:;"><i class="bi bi-instagram"></i></a>
             </div>
             <div class="mb-4 mt-4">
              <h5 class="mb-0 fw-bold">Support</h5>
              <p class="mb-0 text-muted">support@example.com</p>
             </div>
             <div class="">
              <h5 class="mb-0 fw-bold">Toll Free</h5>
              <p class="mb-0 text-muted">1800- 8xx 2xx</p>
             </div>
          </div>
        </div>
       </div><!--end row-->
       <div class="my-5"></div>
       <div class="row">
         <div class="col-12">
           <div class="text-center">
            <h5 class="fw-bold mb-3">Download Mobile App</h5>
           </div>
          <div class="app-icon d-flex flex-column flex-sm-row align-items-center justify-content-center gap-2">
            <div>
              <a href="javascript:;">
                <img src="assets/images/play-store.webp" width="160" alt="">
              </a>
            </div>
            <div>
              <a href="javascript:;">
                <img src="assets/images/apple-store.webp" width="160" alt="">
              </a>
            </div>
          </div>
         </div>
       </div><!--end row-->

    </div>
  </section>
  <!--end footer-->

  <footer class="footer-strip text-center py-3 bg-section-2 border-top positon-absolute bottom-0">
    <p class="mb-0 text-muted">Â© 2022. www.example.com | All rights reserved.</p>
  </footer>


<!--start cart-->
<div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header bg-section-2"> 
    <h5 class="mb-0 fw-bold" id="offcanvasRightLabel">8 items in the cart</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
      <div class="cart-list" id="cart-list">

      
      </div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <div class="d-grid">
        <button type="button" class="btn btn-lg btn-dark btn-ecomm px-5 py-3" onclick="window.location.href='cart.html';">Go To Cart</button>
      </div>
    </div>

</div>
<!--end cat-->


<!--start size modal-->
<div class="modal" id="SizeModal" tabindex="-1">
  
</div>
<!--end size modal-->


<!--start qty modal-->
<div class="modal" id="QtyModal" tabindex="-1">
  
</div>
<!--end qty modal-->



<!--Start Back To Top Button-->
  <a href="javaScript:;" class="back-to-top"><i class="bi bi-arrow-up"></i></a>
<!--End Back To Top Button-->
  

   <!-- JavaScript files -->
   <script src="assets/js/bootstrap.bundle.min.js"></script>
   <script src="assets/js/jquery.min.js"></script>
   <script src="assets/plugins/slick/slick.min.js"></script>
   <script src="assets/js/main.js"></script>
   <script src="assets/js/loader.js"></script>
   <script src="cart-common.js"></script>
  <script src="common.js"></script>
    <script>
    let selectedSize = "";
    let quantity = 0;
    function setSize(size){
      selectedSize = size;
    }
    function getSize(){
        return selectedSize;
    }

    function setQty(qty){
      quantity = qty;
    }
    function getQty(){
        return quantity;
    }

    async function changeSize(product, variantId){
        const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
        let size = getSize();
        if(!user){
          let cart = [];

          if (sessionStorage.getItem('localCart')) {
              try {
                  cart = JSON.parse(sessionStorage.getItem('localCart')) || [];
              } catch (error) {
                  cart = []; 
              }
          }

          const existingItemIndex = cart.findIndex(item => {
                return item.product.id === product.id; 
          });

          if (existingItemIndex > -1) {
              cart[existingItemIndex].size = size;
          }
          sessionStorage.setItem('localCart', JSON.stringify(cart));
          const doneButton = document.getElementById('closeSizeModel');
          doneButton.click();
          showCartItems();

        }else{
            const userId = user.id;
            try{
                const existingCart = await fetchCart(userId);
                const existingItemIndex = existingCart.findIndex(item => 
                    item.product.id === product.id &&
                    item.variantId === variantId);
                if (existingItemIndex > -1) {
                      existingCart[existingItemIndex].size = size;
                      const cartToUpdate = existingCart.find(item =>
                          item.variantId === variantId
                      );
                      if(cartToUpdate){
                        const itemId = cartToUpdate.id;
                        cartToUpdate.size = size;
                        const response = await fetch(`http://localhost:3000/cart/userId/${userId}/itemId/${itemId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cartToUpdate)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update online cart item quantity');
                        }
                        else{
                          console.log("size updated");
                          const doneButton = document.getElementById('closeSizeModel');
                          doneButton.click();
                          showCartItems();
                        }
                    }
              }   
            }catch(error){
                console.log(error);
            }
        }
    }

    async function updateCartOnline(quantity){
        try{
            const existingCart = await fetchCart(userId);
            console.log(existingCart);
            const existingItemIndex = existingCart.findIndex(item => 
                item.product.id === productData.product.id &&
                item.variantId === productData.variantId &&
                item.size === productData.size );

            if (existingItemIndex > -1) {
                existingCart[existingItemIndex].quantity = quantity;
                await updateCartItemQuantity(userId, existingCart[existingItemIndex].id, existingCart[existingItemIndex].quantity);
            }   
        }catch(error){

        }
    }
    function RemoveItemFromCart(itemIndex, productId){
      console.log(itemIndex);
      if (!sessionStorage.getItem('loggedInUser')) {
          let cart = [];
            if (sessionStorage.getItem('localCart')) {
                try {
                    cart = JSON.parse(sessionStorage.getItem('localCart')) || [];
                } catch (error) {
                    console.error('Error parsing localCart:', error);
                    cart = []; 
                }
            }   
            cart.splice(itemIndex, 1);
            sessionStorage.setItem('localCart', JSON.stringify(cart));
            updateCartCounter();
        } else {
            DeleteFromCartOnline(productId); 
        }
        showCartItems();
    }

    function goToCheckout(){
      if (sessionStorage.getItem('loggedInUser')) {
          window.location.href = 'billing-details.html';
      }
      else{
          alert("Please loging to proceed to checkout");
          window.location.href = 'login.html';
      }
    }
     async function showCartItems(){
          let cartTotal = 0.00;
          let cartDiscount = 0.00;
          const deliveryCharge = 29;
          const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
          let cartItems = [];
            if (user) {
                const userId = user.id;
                try {
                    const response = await fetch(`http://localhost:3000/cart/userId/${userId}`);
                    if (!response.ok) {
                        throw new Error('Failed to fetch online cart');
                    }
                    cartItems = await response.json(); 
                } catch (error) {
                    console.error('Error fetching online cart:', error);
                    cartItems = JSON.parse(sessionStorage.getItem('localCart')) || [];
                }
            } else {
                cartItems = JSON.parse(sessionStorage.getItem('localCart')) || [];
            }
            let totalQuantity = cartItems.reduce((accumulator, item) => {
              return accumulator + item.quantity;
            }, 0);
            //console.log(cartItems);
            let cartDisplay = `<div class="container">
              <div class="d-flex align-items-center px-3 py-2 border mb-4">
                <div class="text-start">
                  <h4 class="mb-0 h4 fw-bold">My Bag (${totalQuantity} items)</h4>
              </div>
              <div class="ms-auto">
                <button type="button" class="btn btn-light btn-ecomm">Continue Shopping</button>
              </div>
              </div>
            <div class="row g-4">
              <div class="col-12 col-xl-8">`;
          cartItems.forEach((item , index) => {
            cartTotal += (parseFloat(item.product.price) * parseInt(item.quantity));
            cartDiscount += (((parseFloat(item.product.price) * parseInt(item.quantity)) * parseFloat(item.product.discount))/100);
            let prodThumb = item.product.colors[(item.variantId - 1)].colorImages[0];
            const productData = JSON.stringify(item.product).replace(/"/g, '&quot;');
            //const itemData = JSON.stringify(item).replace(/"/g, '&quot;').replace(/'/g, "\\'");
            //console.log(itemData);
            cartDisplay += `
              <div class="card rounded-0 mb-3">
                <div class="card-body">
                  <div class="d-flex flex-column flex-lg-row gap-3">
                  <div class="product-img">
                      <img src="${prodThumb}" width="150" alt="">
                  </div>
                    <div class="product-info flex-grow-1">
                      <h5 class="fw-bold mb-0">${item.product.name}</h5>
                      <div class="product-price d-flex align-items-center gap-2 mt-3">
                        <div class="h6 fw-bold">$${parseFloat(item.product.price) - parseFloat(((item.product.price) * (item.product.discount))/100)}</div>
                        <div class="h6 fw-light text-muted text-decoration-line-through">$${item.product.price}</div>
                        <div class="h6 fw-bold text-danger">(${item.product.discount}% off)</div>
                      </div>
                      <div class="mt-3 hstack gap-2">
                        <button type="button" class="btn btn-sm btn-light border rounded-0" onclick="selectSize(${productData}, ${item.variantId})">Size : ${item.size}</button>
                        <button type="button" class="btn btn-sm btn-light border rounded-0" onClick="selectQuantity(${productData}, ${item.variantId})">Qty : ${item.quantity}</button>
                    </div>
                  </div>
                  <div class="d-none d-lg-block vr"></div>
                  <div class="d-grid gap-2 align-self-start align-self-lg-center">
                      <button type="button" class="btn btn-ecomm" onclick="javascript:RemoveItemFromCart(${index} , ${item.product.id})"><i class="bi bi-x-lg me-2"></i>Remove</button>
                      <button type="button" class="btn dark btn-ecomm"><i class="bi bi-suit-heart me-2"></i>Move to Wishlist</button>
                  </div>
                  </div>
                </div>
              </div> `;
          });
          
          cartDisplay += `
            </div>
            <div class="col-12 col-xl-4">
                <div class="card rounded-0 mb-3">
                  <div class="card-body">
                    <h5 class="fw-bold mb-4">Order Summary</h5>
                    <div class="hstack align-items-center justify-content-between">
                      <p class="mb-0">Bag Total</p>
                      <p class="mb-0">$${cartTotal}</p>
                    </div>
                    <hr>
                    <div class="hstack align-items-center justify-content-between">
                      <p class="mb-0">Bag discount</p>
                      <p class="mb-0 text-success">- $${cartDiscount}</p>
                    </div>
                    <hr>
                    <div class="hstack align-items-center justify-content-between">
                      <p class="mb-0">Delivery</p>
                      <p class="mb-0">$${cartTotal > 0 ? deliveryCharge : 0.00 }</p>
                    </div>
                    <hr>
                    <div class="hstack align-items-center justify-content-between fw-bold text-content">
                      <p class="mb-0">Total Amount</p>
                      <p class="mb-0">$${cartTotal > 0 ? ((cartTotal - cartDiscount) + deliveryCharge) : 0.00}</p>
                    </div>
                    <div class="d-grid mt-4">
                        <button type="button" onclick="javascript:goToCheckout()" class="btn btn-dark btn-ecomm py-3 px-5">Go To Checkout</button>
                    </div>
                  </div>
                </div>
                <div class="card rounded-0">
                  <div class="card-body">
                    <h5 class="fw-bold mb-4">Apply Coupon</h5>
                    <div class="input-group">
                      <input type="text" class="form-control rounded-0" placeholder="Enter coupon code">
                      <button class="btn btn-dark btn-ecomm rounded-0" type="button">Apply</button>
                    </div>
                  </div>
                </div>


            </div>
          </div><!--end row-->
              
            </div>`;
            document.getElementById('cartItems').innerHTML = cartDisplay;

      }

      function selectSize(product, variantId, item){
          //console.log(product);
          const prodThumb = product.colors[(variantId - 1)].colorImages[0];
          const sizes = product.colors[(variantId - 1)].sizes;
          const productData = JSON.stringify(product).replace(/"/g, '&quot;');
          //const itemData = JSON.stringify(item).replace(/"/g, '&quot;').replace(/'/g, "\\'");
          let modelHTML = `<div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-0">
              <div class="modal-body">
                <div class="d-flex gap-3">
                  <div class="product-img">
                    <img src="${prodThumb}" width="80" alt="">
                  </div>
                  <div class="product-info flex-grow-1">
                    <h6 class="fw-bold mb-0">${product.name}</h6>
                    <div class="product-price d-flex align-items-center gap-2 mt-2">
                      <div class="h6 fw-bold">$${parseFloat(product.price) - ((parseFloat(product.price) * parseFloat(product.discount))/100)}</div>
                      <div class="h6 fw-light text-muted text-decoration-line-through">$${product.price}</div>
                      <div class="h6 fw-bold text-danger">(${product.discount}% off)</div>
                    </div>
                  </div>
                  <div class="">
                      <button type="button" class="btn-close" id="closeSizeModel" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                </div>
                  <hr>
                <div class="size-chart mt-4">
                  <h5 class="fw-bold mb-4">Select Size</h5>
                  <div class="d-flex align-items-center gap-3 flex-wrap">`;

          sizes.forEach(size => {
            modelHTML += `<div class="">
                    <button type="button" onclick="javascript:setSize('${size.sizeName}')">${size.sizeName}</button>
                  </div>`;
          })
                
          modelHTML += `
                </div>
                </div>

                <div class="d-grid mt-4">
                  <button type="button" onclick="javascript:changeSize(${productData}, ${variantId})" class="btn btn-dark btn-ecomm">Done</button>
                </div>

              </div>
            </div>
          </div>`;
          document.getElementById('SizeModal').innerHTML = modelHTML;
          const modal = new bootstrap.Modal(document.getElementById('SizeModal'));
          modal.show();
      }

      async function updateCartItemQty(product, variantId){
        const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
        let qty = getQty();
        if(!user){
          let cart = [];

          if (sessionStorage.getItem('localCart')) {
              try {
                  cart = JSON.parse(sessionStorage.getItem('localCart')) || [];
              } catch (error) {
                  cart = []; 
              }
          }

          const existingItemIndex = cart.findIndex(item => {
                return item.product.id === product.id; 
          });

          if (existingItemIndex > -1) {
              cart[existingItemIndex].quantity = qty;
          }

          sessionStorage.setItem('localCart', JSON.stringify(cart));
          const doneButton = document.getElementById('closeQtyModel');
          doneButton.click();
          showCartItems();

        }else{
            const userId = user.id;
            try{
                const existingCart = await fetchCart(userId);
                const existingItemIndex = existingCart.findIndex(item => 
                    item.product.id === product.id &&
                    item.variantId === variantId);
                if (existingItemIndex > -1) {
                      const cartToUpdate = existingCart.find(item =>
                          item.variantId === variantId
                      );
                      if(cartToUpdate){
                        const itemId = cartToUpdate.id;
                        cartToUpdate.quantity = qty;
                        const response = await fetch(`http://localhost:3000/cart/userId/${userId}/itemId/${itemId}`, {
                            method: 'PATCH',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cartToUpdate)
                        });

                        if (!response.ok) {
                            throw new Error('Failed to update online cart item quantity');
                        }
                        else{
                          console.log("qty updated");
                          const doneButton = document.getElementById('closeQtyModel');
                          doneButton.click();
                          showCartItems();
                        }
                    }
              }   
            }catch(error){
                console.log(error);
            }
        }
      }

      function selectQuantity(product, variantId){
          const productData = JSON.stringify(product).replace(/"/g, '&quot;');
            let qtyModelHTML = `<div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content rounded-0">
              <div class="modal-body">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="">
                    <h5 class="fw-bold mb-0">Select Quantity</h5>
                  </div>
                  <div class="">
                      <button type="button" id="closeQtyModel" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                </div>
                  <hr>
                <div class="size-chart">
                  <div class="d-flex align-items-center gap-3 flex-wrap">`;
                  for(let i = 1; i<=12; i++)  {
                      qtyModelHTML += ` <div class="">
                            <button type="button" onclick="setQty(${i})">${i}</button>
                          </div>`;
                  }
                 
        qtyModelHTML += `
                </div>
                </div>

                <div class="d-grid mt-4">
                  <button type="button" onclick="javascript:updateCartItemQty(${productData}, ${variantId})"  class="btn btn-dark btn-ecomm">Done</button>
                </div>

              </div>
            </div>
          </div>`;
          document.getElementById('QtyModal').innerHTML = qtyModelHTML;
          const modal = new bootstrap.Modal(document.getElementById('QtyModal'));
          modal.show();

      }

      document.addEventListener("DOMContentLoaded", function() {
      fetch('header.html')
          .then(response => response.text())
          .then(data => {
              document.getElementById('header-container').innerHTML = data;
              updateCart();
              checkLogin();
              updateCartCounter();
              showCartItems();
          });
    }); 
    </script>

</body>

</html>