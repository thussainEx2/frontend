<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!--favicon-->
	<link rel="icon" href="assets/images/favicon-32x32.webp" type="image/webp" />

  <!-- CSS files -->
  <link href="assets/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <!-- Plugins -->
  <link rel="stylesheet" type="text/css" href="assets/plugins/slick/slick.css" />
  <link rel="stylesheet" type="text/css" href="assets/plugins/slick/slick-theme.css" />

  <link href="assets/css/style.css" rel="stylesheet">
  <link href="assets/css/dark-theme.css" rel="stylesheet">

  <title>Shopingo - eCommerce HTML Template</title>
</head>

<body>

  <!--page loader-->
  <div class="loader-wrapper">
   <div class="d-flex justify-content-center align-items-center position-absolute top-50 start-50 translate-middle">
     <div class="spinner-border text-dark" role="status">
       <span class="visually-hidden">Loading...</span>
     </div>
   </div>
 </div>
<!--end loader-->

  <!--start top header-->
  <div id="header-container">


  </div>
  <!--end top header-->


<!--start page content-->
<div class="page-content">

   <!--start breadcrumb-->
   <div class="py-4 border-bottom">
    <div class="container">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0"> 
          <li class="breadcrumb-item"><a href="javascript:;">Home</a></li>
          <li class="breadcrumb-item"><a href="javascript:;">checkout</a></li>
          <li class="breadcrumb-item active" aria-current="page">Billing Details</li>
        </ol>
      </nav>
    </div>
   </div>
   <!--end breadcrumb-->

   <!--start product details-->
   <section class="section-padding">
    <div class="container">
      <div class="d-flex align-items-center px-3 py-2 border mb-4">
        <div class="text-start">
          <h4 class="mb-0 h4 fw-bold">Billing Details</h4>
       </div>
      </div>
	   <div class="row g-4">
	     <div class="col-12 col-lg-8 col-xl-8">

        <h6 class="fw-bold mb-3 py-2 px-3 bg-light">Personal Details</h6>
		    <div class="card rounded-0 mb-3">
			  <div class="card-body">
			    <div class="row g-3">
             <div class="col-12 col-lg-6">
              <div class="form-floating">
                <input type="text" name="firstName" class="form-control rounded-0" id="firstName" placeholder="First Name">
                <label for="floatingFirstName">First Name</label>
              </div>
             </div>
             <div class="col-12 col-lg-6">
              <div class="form-floating">
                <input type="text" class="form-control rounded-0" name="lastName" id="lastName" placeholder="Last Name">
                <label for="floatingLastName">Last Name</label>
              </div>
             </div>
             <div class="col-12 col-lg-6">
              <div class="form-floating">
                <input type="text" class="form-control rounded-0" name="email" id="email" placeholder="Email">
                <label for="floatingEmail">Email</label>
              </div>
             </div>

             <div class="col-12 col-lg-6">
              <div class="form-floating">
                <input type="text" class="form-control rounded-0" name="mobileNumber" id="mobileNumber" placeholder="Mobile No">
                <label for="floatingMobileNo">Mobile No</label>
              </div>
             </div>
          </div><!--end row-->
			  </div>
			</div> 

      <h6 class="fw-bold mb-3 py-2 px-3 bg-light">Shipping Details</h6>
		    <div class="card rounded-0">
			  <div class="card-body">
          <div class="row g-3">
            <div class="col-12 col-lg-12">
             <div class="form-floating">
               <input type="text" class="form-control rounded-0" name="streetAddress" id="streetAddress" placeholder="Street Address">
               <label for="floatingStreetAddress">Street Address</label>
             </div>
            </div>
            <div class="col-12 col-lg-4">
             <div class="form-floating">
               <input type="text" class="form-control rounded-0" name="zipCode" id="zipCode" placeholder="Zip Code">
               <label for="floatingZipCode">Zip Code</label>
             </div>
            </div>
            <div class="col-12 col-lg-4">
             <div class="form-floating">
               <input type="text" class="form-control rounded-0" name="city" id="city" placeholder="City">
               <label for="floatingCity">City</label>
             </div>
            </div>
            <div class="col-12 col-lg-4">
             <div class="form-floating">
               <input type="text" class="form-control rounded-0" name="country" id="country" placeholder="Country">
               <label for="floatingCountry">Country</label>
             </div>
            </div>
         </div><!--end row-->
			  </div>
			</div> 


		 </div>
		 <div class="col-12 col-lg-4 col-xl-4" >
      <div class="card rounded-0 mb-3">
        <div class="card-body">
          <div id="orderTotal">
          </div>
          <input type="hidden" id="discount" value="0">
            <input type="hidden" id="orderPrice" value="0">
            <input type="hidden" id="deliveryCharge" value="0">
          <div class="d-grid mt-4">
            <button type="button" id="placeOrderButton" class="btn btn-dark btn-ecomm py-3 px-5">Place Order</button>
        </div>
      </div>
      </div>
		 </div>
	 </div><!--end row-->
       
    </div>
  </section>
   <!--start product details-->



 </div>
  <!--end page content-->


  <!--start footer-->
  <section class="footer-section bg-section-2 section-padding">
    <div class="container">
       <div class="row row-cols-1 row-cols-lg-4 g-4">
        <div class="col">
          <div class="footer-widget-6">
            <img src="assets/images/logo.webp" class="logo-img mb-3" alt="">
            <h5 class="mb-3 fw-bold">About Us</h5>
             <p class="mb-2">There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in some form, by injected humour, or randomised words which don't look even slightly believable.</p>

             <a class="link-dark" href="javascript:;">Read More</a>
          </div>
        </div>
        <div class="col">
          <div class="footer-widget-7">
            <h5 class="mb-3 fw-bold">Explore</h5>
             <ul class="widget-link list-unstyled">
               <li><a href="javascript:;">Fashion</a></li>
               <li><a href="javascript:;">Women</a></li>
               <li><a href="javascript:;">Furniture</a></li>
               <li><a href="javascript:;">Shoes</a></li>
               <li><a href="javascript:;">Topwear</a></li>
               <li><a href="javascript:;">Brands</a></li>
               <li><a href="javascript:;">Kids</a></li>
             </ul>
          </div>
        </div>
        <div class="col">
          <div class="footer-widget-8">
            <h5 class="mb-3 fw-bold">Company</h5>
             <ul class="widget-link list-unstyled">
               <li><a href="javascript:;">About Us</a></li>
               <li><a href="javascript:;">Contact Us</a></li>
               <li><a href="javascript:;">FAQ</a></li>
               <li><a href="javascript:;">Privacy</a></li>
               <li><a href="javascript:;">Terms</a></li>
               <li><a href="javascript:;">Complaints</a></li>
             </ul>
          </div>
        </div>
        <div class="col">
          <div class="footer-widget-9">
            <h5 class="mb-3 fw-bold">Follow Us</h5>
             <div class="social-link d-flex align-items-center gap-2">
               <a href="javascript:;"><i class="bi bi-facebook"></i></a>
               <a href="javascript:;"><i class="bi bi-twitter"></i></a>
               <a href="javascript:;"><i class="bi bi-linkedin"></i></a>
               <a href="javascript:;"><i class="bi bi-youtube"></i></a>
               <a href="javascript:;"><i class="bi bi-instagram"></i></a>
             </div>
             <div class="mb-4 mt-4">
              <h5 class="mb-0 fw-bold">Support</h5>
              <p class="mb-0 text-muted">support@example.com</p>
             </div>
             <div class="">
              <h5 class="mb-0 fw-bold">Toll Free</h5>
              <p class="mb-0 text-muted">1800- 8xx 2xx</p>
             </div>
          </div>
        </div>
       </div><!--end row-->
       <div class="my-5"></div>
       <div class="row">
         <div class="col-12">
           <div class="text-center">
            <h5 class="fw-bold mb-3">Download Mobile App</h5>
           </div>
          <div class="app-icon d-flex flex-column flex-sm-row align-items-center justify-content-center gap-2">
            <div>
              <a href="javascript:;">
                <img src="assets/images/play-store.webp" width="160" alt="">
              </a>
            </div>
            <div>
              <a href="javascript:;">
                <img src="assets/images/apple-store.webp" width="160" alt="">
              </a>
            </div>
          </div>
         </div>
       </div><!--end row-->

    </div>
  </section>
  <!--end footer-->

  <footer class="footer-strip text-center py-3 bg-section-2 border-top positon-absolute bottom-0">
    <p class="mb-0 text-muted">Â© 2022. www.example.com | All rights reserved.</p>
  </footer>


<!--start cart-->
<div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="offcanvasRight" aria-labelledby="offcanvasRightLabel">
  <div class="offcanvas-header bg-section-2"> 
    <h5 class="mb-0 fw-bold" id="offcanvasRightLabel">8 items in the cart</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
      <div class="cart-list" id="cart-list">

      </div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <div class="d-grid">
        <button type="button" class="btn btn-lg btn-dark btn-ecomm px-5 py-3" onclick="window.location.href='cart.html';">Go To Cart</button>
      </div>
    </div>

</div>
<!--end cat-->


<!--Start Back To Top Button-->
  <a href="javaScript:;" class="back-to-top"><i class="bi bi-arrow-up"></i></a>
<!--End Back To Top Button-->
  

   <!-- JavaScript files -->
   <script src="assets/js/bootstrap.bundle.min.js"></script>
   <script src="assets/js/jquery.min.js"></script>
   <script src="assets/plugins/slick/slick.min.js"></script>
   <script src="assets/js/main.js"></script>
   <script src="assets/js/loader.js"></script>
   <script src="cart-common.js"></script>
   <script src="common.js"></script>

   <script>

    async function getCartData(){
      const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
        let cart = [];
        if(!user){
          if (sessionStorage.getItem('localCart')) {
              try {
                  cart = JSON.parse(sessionStorage.getItem('localCart')) || [];
              } catch (error) {
                  cart = []; 
              }
          }
        }else{
          try{
            const userId = user.id;
            cart = await fetchCart(userId);

          }catch(error){
              console.log(error);
              return false;
          }
        }
        return cart;
    }
    async function saveOrderData(userId) {
        const apiUrl = 'http://localhost:3000/orders';
        const orderData = {
            firstName: document.getElementById('firstName').value,
            lastName: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            mobileNumber: document.getElementById('mobileNumber').value,
            streetAddress: document.getElementById('streetAddress').value,
            zipCode: document.getElementById('zipCode').value,
            city: document.getElementById('city').value,
            country: document.getElementById('country').value,
            orderTotal: parseFloat(document.getElementById('orderPrice').value),
            discount: parseFloat(document.getElementById('discount').value) || 0,
            deliveryCharge: parseFloat(document.getElementById('deliveryCharge').value) || 0,
            userId: userId,
            orderDetails: [] 
        };

        const cart = await getCartData();
        for (const item of cart) {
          let sizeId = item.product.colors[(item.variantId-1)].sizes.find((size, index) => {return size.sizeName === item.size}).id;
          let colorId = item.product.colors[(item.variantId-1)].id;
          const orderDetail = {
              productId: item.product.id, 
              price: parseFloat(item.product.price),   
              discount: parseFloat(item.product.discount) || 0, 
              quantity: item.quantity, 
              productColorId: colorId, 
              productSizeId: sizeId 
          };
          orderData.orderDetails.push(orderDetail);
        }
        console.log("Order Data" + JSON.stringify(orderData, null, 13));
        if (!validateOrderData(orderData)) {
            alert("Please fill all required fields!");
            return;
        }

        

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData),
            });

            if (!response.ok) {
                throw new Error(`Error: ${response.statusText}`);
            }

            const result = await response.json();
            console.log('Order saved successfully:', result);
            if(result.orderNumber){
                const delRes = await fetch(`http://localhost:3000/cart/userId/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if(delRes){
                  window.location.href = "thank-you.html?orderNumber="+ result.orderNumber;
                }
            }

        } catch (error) {
            console.error('Error saving order data:', error);
        }
    }

    function validateOrderData(data) {
        if (!data.firstName || !data.lastName || !data.email || !data.mobileNumber ||
            !data.streetAddress || !data.zipCode || !data.city || !data.country ||
            !data.orderTotal || !data.orderDetails.length) {
            return false;
        }
        return true;
    }

    document.getElementById('placeOrderButton').addEventListener('click', function() {
        const user = JSON.parse(sessionStorage.getItem('loggedInUser'));
        const userId = user.id;
        const orderDetails = saveOrderData(userId);
        //console.log(orderDetails);
    });

    async function loadOrderTotal(){
        const cart = await getCartData();
        const deliveryCharge = 29;
        // for (const item of cart) {
        //   console.log(item.product.colors[(item.variantId-1)].sizes.find((size, index) => {return size.sizeName === item.size}).id);
        //   console.log(item.product.colors[(item.variantId-1)].id);
        // }
        let orderTotal = cart.reduce((accumulator, item) => {
              return accumulator + parseFloat(item.product.price);
        }, 0);
        let orderDiscount = cart.reduce((accumulator, item) => {
              return accumulator + parseFloat(item.product.discount);
        }, 0);
        
        let orderData = `
             <h5 class="fw-bold mb-4">Order Summary</h5>
             <div class="hstack align-items-center justify-content-between">
               <p class="mb-0">Bag Total</p>
               <p class="mb-0">$${orderTotal}</p>
             </div>
             <hr>
             <div class="hstack align-items-center justify-content-between">
              <p class="mb-0">Bag discount</p>
              <p class="mb-0 text-success">- $${orderDiscount}</p>
            </div>
            <hr>
            <div class="hstack align-items-center justify-content-between">
              <p class="mb-0">Delivery</p>
              <p class="mb-0">$${deliveryCharge}</p>
            </div>
            <hr>
            <div class="hstack align-items-center justify-content-between fw-bold text-content">
              <p class="mb-0">Total Amount</p>
              <p class="mb-0">$${((orderTotal-orderDiscount) + deliveryCharge)}</p>
            </div>`;
         document.getElementById("orderPrice").value = orderTotal;
         document.getElementById("deliveryCharge").value = deliveryCharge;
         document.getElementById("discount").value = orderDiscount;
         console.log(document.getElementById("discount").value);
         document.getElementById("orderTotal").innerHTML = orderData;
    }
    document.addEventListener("DOMContentLoaded", function() {
      fetch('header.html')
          .then(response => response.text())
          .then(data => {
              document.getElementById('header-container').innerHTML = data;
              updateCart();
              checkLogin();
              updateCartCounter();
              loadOrderTotal();
          });
    }); 
   </script>


</body>

</html>